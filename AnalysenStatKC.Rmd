---
title: "Analysen- & Methoden Statistik Klinische Chemie"
author: "Oliver Speer"
date: "2023-03-20"
output:
  officedown::rdocx_document:
    reference_docx: Formatvorlage_labStatKC.docx
    plots:
      style: Normal
      align: center
      caption:
        style: Image Caption
        pre: 'Figure '
        sep: ':'
---

```{r setup, include=FALSE}
library(knitr)
library(tidyverse)
library(parallel)
library(robslopes)
library(readxl)
library(officedown)
library(officer)
library(flextable)
set_flextable_defaults(font.size = 11, padding = 3)
use_df_printer()
opts_chunk$set(echo = TRUE, ft.align = "center", fig.align = "center")
```


##  Umsatz und Analysezahlen in der Klinischen Chemie ZLM SG 

### Hochdurchsatz  
  
Die Hochdurchsatz-Chemie bestehend aus 2 AU5800 und 2 DxI-800 bildet das Rückrat des KCHI. Ein regelmässiges Monitoring der Umsatzentwicklung in diesem Bereich sollte, neben HRM und QM, ein zentrales Element der Führung der Klinischen Chemie sein.   
  
#### AU5800




```{r prepare_AU_data, echo=FALSE, message=FALSE, warning=FALSE}
# import data
library(readxl)
tarif.scales <- read_excel("UmsatzStatistik.xlsx", col_types = c(
  "text",
  "text",
  "text",
  "skip",
  "skip",
  "skip",
  "numeric",
  "skip",
  "numeric",
  "skip"))

head1 <- read_excel("globaldata.xlsx", col_names = TRUE) %>% names()
head2 <- read_excel("globaldata.xlsx", skip = 1, col_names = TRUE) %>% names()
head <- paste0(head2, sep = "_", head1)
global.data <- read_excel("globaldata.xlsx", skip = 2, col_names = head, col_types =
                            c(
                              "text",
                              "numeric",
                              "skip",
                              "skip",
                              "date",
                              "text",
                              "text",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric"
                            ))

global.data <- global.data |> filter(!grepl("Tagesnummer", global.data$a_Tagesnummer))
global.data <- global.data |> filter(!is.na(a_Tagesnummer))


# change day-number to date and reorder column
global.data$Datum <- ymd(substr(global.data$a_Tagesnummer, 1, 10))

global.data <- global.data |> relocate(Datum, .before = g_Auftragg.)
#global.data <- cbind(global.data[,1:4], Datum = global.data$Datum, 
                    # global.data[,5:ncol(global.data)])

# create new data frame, sort analysis-names in one column (Bezeichnung), 
#code into another (Methode) and results into a third (Werte)
analy.pivot <- global.data |> pivot_longer(
  cols = !(a_Tagesnummer:Datum), 
  names_to = c("Bezeichnung","Methode"),
  names_sep = "_",
  values_to = "Werte",
  values_drop_na = TRUE)

#left join to get tax point information from tariff, remove junk data, save tidy data
tidy.AU.data <- left_join(analy.pivot, tarif.scales, by = c("Bezeichnung", "Methode"), keep = FALSE, multiple = "any")

tidy.AU.data <- subset(tidy.AU.data, select = -c(Tagesnummer))

#call age
tidy.AU.data$Alter <- year(tidy.AU.data$Datum) - year(tidy.AU.data$e_Geb.datum) - (month(tidy.AU.data$Datum) < month(tidy.AU.data$e_Geb.datum) | (month(tidy.AU.data$Datum) == month(tidy.AU.data$e_Geb.datum) & day(tidy.AU.data$Datum) < day(tidy.AU.data$e_Geb.datum)))

# tidy.AU.data <- cbind(tidy.AU.data[,1:3], Alter = tidy.AU.data$Alter, 
#                      tidy.AU.data[,4:ncol(tidy.AU.data)])
tidy.AU.data <- tidy.AU.data |> relocate(Alter, .before = f_Geschl.)


write.csv2(tidy.AU.data, "tidyAUdataTxp.csv", col.names = TRUE)

#global.data.sort <- global.data |> group_by(Datum) |>
#  summarise(
#    NaCount = sum(!is.na(Natrium)),
#    CRPCount = sum(!is.na(CRP)),
#    CRPhs = sum(!is.na(`CRP (hoch sensitiv)`))
#  )
```

```{r flex tidy.data into summary, echo=FALSE, message=FALSE, warning=FALSE}
tidy.AU.data$Year_Month <- format(ymd(tidy.AU.data$Datum), "%Y-%m")
tidy.AU.data$Quarter 

AU.sum.data <- tidy.AU.data |> 
  group_by(Year_Month) |> 
  summarize(AU_TxpUmsatz = sum(!is.na(Taxpkt.)),
            AU_Aufträge = n_distinct(a_Tagesnummer),
            Anz_Patienten = n_distinct(b_Fallnummer)
            )

AU.sum.data |> flextable() |> 
  theme_vanilla() |> 
  bg(bg = "grey", part = "header") |> 
  set_table_properties(width = 0.8, layout = "autofit") |> 
  colformat_date(fmt_date = "%d/%m/%Y")

```


```{r show DxI analysis, echo=FALSE, message=FALSE, warning=FALSE}
AU.sum.method <- tidy.AU.data |> 
     mutate(Quarter = paste0("Q", quarter(floor_date(Datum, "quarter"))),
            Year = year(Datum)) |> 
     filter(Year == 2022) |> 
     summarise(
         Analysen = n(),
         .by = c(Quarter, Year, Bezeichnung)
     ) |> 
     pivot_wider(
         names_from = c(Quarter, Year), 
         values_from = Analysen, 
         names_glue = "{Quarter}_{Year}",
         names_sort = TRUE
     )

AU.sum.method |> 
  flextable() |> 
  theme_vanilla() |> 
  align(align = "center", part = "all")|> 
  bg(bg = "grey", part = "header") |> 
  set_table_properties(width = 0.8, layout = "autofit")


```


```{r plotAU, echo=FALSE, message=FALSE, warning=FALSE}
# ggplot(data = global.data.sort) + 
#   geom_point(mapping =  aes(Datum, CRPCount,)) +
#     geom_point(mapping = aes(Datum, NaCount))
```



#### DxI-800
```{r tidyup_DxI_data, echo=FALSE, message=FALSE, warning=FALSE}

tarif.scales <- read_excel("UmsatzStatistik.xlsx", col_types = c(
  "text",
  "text",
  "text",
  "skip",
  "skip",
  "skip",
  "numeric",
  "skip",
  "numeric",
  "skip"))



head1 <- read_excel("dxidata.xlsx", col_names = TRUE) |>  names()
head2 <- read_excel("dxidata.xlsx", skip = 1, col_names = TRUE)  |>  names()
head <- paste0(head2, sep = "_", head1)
global.dxi.data <- read_excel("dxidata.xlsx", skip = 2, col_names = head, col_types =
                            c(
                              "text",
                              "numeric",
                              "skip",
                              "skip",
                              "date",
                              "text",
                              "text",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric"
                            ))

global.dxi.data <- global.dxi.data |> filter(!grepl("Tagesnummer", global.dxi.data$a_Tagesnummer))
global.dxi.data <- global.dxi.data |> filter(!is.na(a_Tagesnummer))


# change day-number to date and reorder column
global.dxi.data$Datum <- ymd(substr(global.dxi.data$a_Tagesnummer, 1, 10))

global.dxi.data <- global.dxi.data |> relocate(Datum, .before = `a-Fetoprotein_14097`)   


# create new data frame, sort analysis-names in one column (Bezeichnung), 
#code into another (Methode) and results into a third (Werte)
dxi.analy.pivot <- global.dxi.data |> pivot_longer(
  cols = !(a_Tagesnummer:Datum), 
  names_to = c("Bezeichnung","Methode"),
  names_sep = "_",
  values_to = "Werte",
  values_drop_na = TRUE)

#left join to get tax point information from tariff, remove junk data, save tidy data
tidy.dxi.data <- left_join(dxi.analy.pivot, tarif.scales, by = c("Bezeichnung", "Methode"), keep = FALSE, multiple = "any")

tidy.dxi.data <- subset(tidy.dxi.data, select = -c(Tagesnummer))

#call age
tidy.dxi.data$Alter <- year(tidy.dxi.data$Datum) - year(tidy.dxi.data$e_Geb.datum) - (month(tidy.dxi.data$Datum) < month(tidy.dxi.data$e_Geb.datum) | (month(tidy.dxi.data$Datum) == month(tidy.dxi.data$e_Geb.datum) & day(tidy.dxi.data$Datum) < day(tidy.dxi.data$e_Geb.datum)))

tidy.dxi.data <- tidy.dxi.data |> relocate(Alter, .before = f_Geschl.)


write.csv2(tidy.dxi.data, "tidy_DxI_dataTxp.csv", col.names = TRUE)

```
  

```{r flex tidy.data into summary, echo=FALSE, message=FALSE, warning=FALSE}
tidy.dxi.data$Year_Month <- format(ymd(tidy.dxi.data$Datum), "%Y-%m")


dxi.sum.data <- tidy.dxi.data |> 
  group_by(Year_Month) |> 
  summarize(DxI_TxpUmsatz = sum(!is.na(Taxpkt.)),
            DxI_Aufträge = n_distinct(a_Tagesnummer),
            Anz_Patienten = n_distinct(b_Fallnummer)
            )
dxi.sum.data$TxpUmsatz <- dxi.sum.data$DxI_TxpUmsatz
dxi.sum.data <- dxi.sum.data |> relocate(TxpUmsatz,  .before = DxI_TxpUmsatz)

dxi.sum.data |> flextable() |> 
  theme_vanilla() |> 
  bg(bg = "grey", part = "header") |> 
  mk_par(j = 2,
          value = as_paragraph(
            linerange(value = DxI_TxpUmsatz, max = max(DxI_TxpUmsatz), height = .15)
            ),
  part = "body") |> 
  set_header_labels(
    DxI_TxpUmsatz = " ",
    DxI_Aufträge = "Aufträge",
    Anz_Patienten = "Patienten (n)"
  ) |> merge_at(j = c(2, 3), part = "header") |> 
  align(align = "center", part = "all")|>
  set_table_properties(width = 0.8, layout = "autofit") |> 
  colformat_date(fmt_date = "%m/%Y") 

```

```{r 2022 DxI analysis, echo=FALSE, message=FALSE, warning=FALSE}
dxi.sum.method <- tidy.dxi.data |> 
     mutate(Quarter = paste0("Q", quarter(floor_date(Datum, "quarter"))),
            Year = year(Datum)) |> 
     filter(Year == 2022) |> 
     summarise(
         Analysen = n(),
         .by = c(Quarter, Year, Bezeichnung)
     ) |> 
     pivot_wider(
         names_from = c(Quarter, Year), 
         values_from = Analysen, 
         # names_glue = "{Quarter}_{Year}",
         names_sort = TRUE
     )




dxi.sum.method |> 
  flextable() |> 
  theme_vanilla() |> 
  bg(bg = "grey", part = "header") |> 
  add_header_row(
    values = c("Methoden", "n in 2022"),
    colwidths = c(1, 4)) |> 
    theme_box() |>  
  set_header_labels(
    Q1_2022 = "Q1",
    Q2_2022 = "Q2",
    Q3_2022 = "Q3",
    Q4_2022 = "Q4"
  ) |> 
  align(align = "center", part = "all")|>
  set_table_properties(width = 0.8, layout = "autofit")


```

  
### Spez. Chemie  

#### BNII Nephelometrie  

```{r tidyup_DxI_data, echo=FALSE, message=FALSE, warning=FALSE}

tarif.scales <- read_excel("UmsatzStatistik.xlsx", col_types = c(
  "text",
  "text",
  "text",
  "skip",
  "skip",
  "skip",
  "numeric",
  "skip",
  "numeric",
  "skip"))



head1 <- read_excel("BNIIdata.xlsx", col_names = TRUE) |>  names()
head2 <- read_excel("BNIIdata.xlsx", skip = 1, col_names = TRUE)  |>  names()
head <- paste0(head2, sep = "_", head1)
global.dxi.data <- read_excel("BNIIdata.xlsx", skip = 2, col_names = head, col_types =
                            c(
                              "text",
                              "numeric",
                              "skip",
                              "skip",
                              "date",
                              "text",
                              "text",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric"
                            ))

global.bn.data <- global.bn.data |> filter(!grepl("Tagesnummer", global.dxi.data$a_Tagesnummer))
global.bn.data <- global.bn.data |> filter(!is.na(a_Tagesnummer))


# change day-number to date and reorder column
global.dxi.data$Datum <- ymd(substr(global.dxi.data$a_Tagesnummer, 1, 10))

global.dxi.data <- global.dxi.data |> relocate(Datum, .before = `a-Fetoprotein_14097`)   


# create new data frame, sort analysis-names in one column (Bezeichnung), 
#code into another (Methode) and results into a third (Werte)
dxi.analy.pivot <- global.dxi.data |> pivot_longer(
  cols = !(a_Tagesnummer:Datum), 
  names_to = c("Bezeichnung","Methode"),
  names_sep = "_",
  values_to = "Werte",
  values_drop_na = TRUE)

#left join to get tax point information from tariff, remove junk data, save tidy data
tidy.dxi.data <- left_join(dxi.analy.pivot, tarif.scales, by = c("Bezeichnung", "Methode"), keep = FALSE, multiple = "any")

tidy.dxi.data <- subset(tidy.dxi.data, select = -c(Tagesnummer))

#call age
tidy.dxi.data$Alter <- year(tidy.dxi.data$Datum) - year(tidy.dxi.data$e_Geb.datum) - (month(tidy.dxi.data$Datum) < month(tidy.dxi.data$e_Geb.datum) | (month(tidy.dxi.data$Datum) == month(tidy.dxi.data$e_Geb.datum) & day(tidy.dxi.data$Datum) < day(tidy.dxi.data$e_Geb.datum)))

tidy.dxi.data <- tidy.dxi.data |> relocate(Alter, .before = f_Geschl.)


write.csv2(tidy.dxi.data, "tidy_DxI_dataTxp.csv", col.names = TRUE)

```
  

```{r flex tidy.data into summary, echo=FALSE, message=FALSE, warning=FALSE}
tidy.dxi.data$Year_Month <- format(ymd(tidy.dxi.data$Datum), "%Y-%m")


dxi.sum.data <- tidy.dxi.data |> 
  group_by(Year_Month) |> 
  summarize(DxI_TxpUmsatz = sum(!is.na(Taxpkt.)),
            DxI_Aufträge = n_distinct(a_Tagesnummer),
            Anz_Patienten = n_distinct(b_Fallnummer)
            )
dxi.sum.data$TxpUmsatz <- dxi.sum.data$DxI_TxpUmsatz
dxi.sum.data <- dxi.sum.data |> relocate(TxpUmsatz,  .before = DxI_TxpUmsatz)

dxi.sum.data |> flextable() |> 
  theme_vanilla() |> 
  bg(bg = "grey", part = "header") |> 
  mk_par(j = 2,
          value = as_paragraph(
            linerange(value = DxI_TxpUmsatz, max = max(DxI_TxpUmsatz), height = .15)
            ),
  part = "body") |> 
  set_header_labels(
    DxI_TxpUmsatz = " ",
    DxI_Aufträge = "Aufträge",
    Anz_Patienten = "Patienten (n)"
  ) |> merge_at(j = c(2, 3), part = "header") |> 
  align(align = "center", part = "all")|>
  set_table_properties(width = 0.8, layout = "autofit") |> 
  colformat_date(fmt_date = "%m/%Y") 

```



```{r 2022 DxI analysis, echo=FALSE, message=FALSE, warning=FALSE}
dxi.sum.method <- tidy.dxi.data |> 
     mutate(Quarter = paste0("Q", quarter(floor_date(Datum, "quarter"))),
            Year = year(Datum)) |> 
     filter(Year == 2022) |> 
     summarise(
         Analysen = n(),
         .by = c(Quarter, Year, Bezeichnung)
     ) |> 
     pivot_wider(
         names_from = c(Quarter, Year), 
         values_from = Analysen, 
         # names_glue = "{Quarter}_{Year}",
         names_sort = TRUE
     )




dxi.sum.method |> 
  flextable() |> 
  theme_vanilla() |> 
  bg(bg = "grey", part = "header") |> 
  add_header_row(
    values = c("Methoden", "n in 2022"),
    colwidths = c(1, 4)) |> 
    theme_box() |>  
  set_header_labels(
    Q1_2022 = "Q1",
    Q2_2022 = "Q2",
    Q3_2022 = "Q3",
    Q4_2022 = "Q4"
  ) |> 
  align(align = "center", part = "all")|>
  set_table_properties(width = 0.8, layout = "autofit")


```


---
  

**Zentrum für Labormedizin St. Gallen, `r paste(format(Sys.time(), '%A %d. %B %Y'))`**




---
 
