---
title: "Analysen- & Methoden Statistik Klinische Chemie"
author: "Oliver Speer"
date: "2023-03-20"
output:
  officedown::rdocx_document:
    reference_docx: Formatvorlage_labStatKC.docx
    plots:
      style: Normal
      align: center
      caption:
        style: Image Caption
        pre: 'Figure '
        sep: ':'
---

```{r setup, include=FALSE}
library(knitr)
library(tidyverse)
library(parallel)
library(robslopes)
library(readxl)
library(officedown)
library(officer)
library(flextable)
set_flextable_defaults(font.size = 11, padding = 3)
use_df_printer()
opts_chunk$set(echo = TRUE, ft.align = "center", fig.align = "center")
```


##  Umsatz und Analysezahlen in der Klinischen Chemie ZLM SG 

### Hochdurchsatz  
  
Die Hochdurchsatz-Chemie bestehend aus 2 AU5800 und 2 DxI-800 bildet das R체ckrat des KCHI. Ein regelm채ssiges Monitoring der Umsatzentwicklung in diesem Bereich sollte, neben HRM und QM, ein zentrales Element der F체hrung der Klinischen Chemie sein.   
  
#### AU5800: Taxpunkt-Umsatz & Auftragszahlen




```{r prepare_AU_data, echo=FALSE, message=FALSE, warning=FALSE}
# import AU data
library(readxl)

#import tariff data
tarif.scales <- read_excel("H:\\Statistiken\\UmsatzStatistik.xlsx", col_types = c(
  "text",
  "text",
  "skip",
  "skip",
  "skip",
  "skip",
  "numeric",
  "skip",
  "numeric"))


# import AU data
# list all files in the directory
files <- list.files("H:\\Statistiken\\")
data_path <- "H:/Statistiken"

# find the file that has the materila and machine in its name

file_pattern <- "BlutAU"


file_name <- files[grep(file_pattern, files)]
full_path <- file.path(data_path, file_name)


head1 <- read_excel(full_path, col_names = TRUE)  |>  names()
head2 <- read_excel(full_path, skip = 1, col_names = TRUE)  |>  names()
head2[1:7] <- c("a", "b", "c", "d", "e", "f", "g")
head <- paste0(head2, sep = "_", head1)
global.data <- read_excel(full_path, skip = 2, col_names = head, col_types =
                            c(
                              "text",
                              "numeric",
                              "skip",
                              "skip",
                              "date",
                              "text",
                              "text",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric"
                            ))

global.data <- global.data |> filter(!grepl("Tagesnummer", global.data$a_Tagesnummer))
global.data <- global.data |> filter(!is.na(a_Tagesnummer))


# change day-number to date and reorder column
global.data$Datum <- ymd(substr(global.data$a_Tagesnummer, 1, 10))

global.data <- global.data |> relocate(Datum, .before = 6)
#global.data <- cbind(global.data[,1:4], Datum = global.data$Datum, 
                    # global.data[,5:ncol(global.data)])

# create new data frame, sort analysis-names in one column (Bezeichnung), 
#code into another (Methode) and results into a third (Werte)
analy.pivot <- global.data |> pivot_longer(
  cols = !(a_Tagesnummer:Datum), 
  names_to = c("Bezeichnung","Methode"),
  names_sep = "_",
  values_to = "Werte",
  values_drop_na = TRUE)

#left join to get tax point information from tariff, remove junk data, save tidy data
tidy.AU.data <- left_join(analy.pivot, tarif.scales, by = c("Methode"), keep = FALSE, multiple = "any")

tidy.AU.data <- subset(tidy.AU.data, select = -c(Tagesnummer))

#call age
tidy.AU.data$Alter <- year(tidy.AU.data$Datum) - year(tidy.AU.data$e_Geb.datum) - (month(tidy.AU.data$Datum) < month(tidy.AU.data$e_Geb.datum) | (month(tidy.AU.data$Datum) == month(tidy.AU.data$e_Geb.datum) & day(tidy.AU.data$Datum) < day(tidy.AU.data$e_Geb.datum)))

# tidy.AU.data <- cbind(tidy.AU.data[,1:3], Alter = tidy.AU.data$Alter, 
#                      tidy.AU.data[,4:ncol(tidy.AU.data)])
tidy.AU.data <- tidy.AU.data |> relocate(Alter, .before = f_Geschl.)


write_excel_csv(tidy.AU.data, "tidyAUdataTxp.csv", col_names = TRUE)


```

```{r flex AU.tidy.data into summary, echo=FALSE, message=FALSE, warning=FALSE}
tidy.AU.data$Year_Month <- format(ymd(tidy.AU.data$Datum), "%Y-%m")


AU.sum.data <- tidy.AU.data |> 
  group_by(Year_Month) |> 
  summarize(AU_TxpUmsatz = sum(ifelse(is.na(Taxpkt.), 0, Taxpkt.)),
            AU_Auftraege = n_distinct(a_Tagesnummer),
            Anz_Patienten = n_distinct(b_Fallnummer)
  )
AU.sum.data$TxpUmsatz <- AU.sum.data$AU_TxpUmsatz + AU.sum.data$AU_Auftraege * 10
AU.sum.data$AU_TxpUmsatz <- AU.sum.data$AU_TxpUmsatz + AU.sum.data$AU_Auftraege * 10
AU.sum.data <- AU.sum.data |> relocate(TxpUmsatz,  .before = AU_TxpUmsatz)

AU.sum.data |> flextable() |> 
  theme_vanilla() |> 
  bg(bg = "grey", part = "header") |> 
  mk_par(j = 2,
         value = as_paragraph(
           linerange(value = AU_TxpUmsatz, max = max(AU_TxpUmsatz), height = .15)
         ),
         part = "body") |> 
  set_header_labels(
    AU_TxpUmsatz = " ",
    AU_Auftraege = "Auftr채ge",
    Anz_Patienten = "Patienten (n)"
  ) |> merge_at(j = c(2, 3), part = "header") |> 
  align(align = "center", part = "all")|>
  set_table_properties(width = 0.8, layout = "autofit") |> 
  colformat_date(fmt_date = "%m/%Y") 

```
<br>

<br>

#### AU5800: Anzahl der einzelnen Analysen pro Quartal


```{r show AU analysis, echo=FALSE, message=FALSE, warning=FALSE}
AU.sum.method <- tidy.AU.data |> 
     mutate(Quarter = paste0("Q", quarter(floor_date(Datum, "quarter"))),
            Year = year(Datum)) |> 
     filter(Year == 2022) |> 
     summarise(
         Analysen = n(),
         .by = c(Quarter, Year, Bezeichnung)
     ) |> 
     pivot_wider(
         names_from = c(Quarter, Year), 
         values_from = Analysen, 
         names_glue = "{Quarter}_{Year}",
         names_sort = TRUE
     )

AU.sum.method |> 
  arrange(desc(Q4_2022)) |> 
  flextable() |> 
  theme_vanilla() |> 
  align(align = "center", part = "all")|> 
  bg(bg = "grey", part = "header") |> 
  set_table_properties(width = 0.8, layout = "autofit")


```


\newpage


#### DxI-800: Taxpunkt-Umsatz & Auftragszahlen
```{r tidyup_DxI_data, echo=FALSE, message=FALSE, warning=FALSE}

# tarif.scales <- read_excel("UmsatzStatistik.xlsx", col_types = c(
#   "text",
#   "text",
#   "text",
#   "skip",
#   "skip",
#   "skip",
#   "numeric",
#   "skip",
#   "numeric",
#   "skip"))

# list all files in the directory
files <- list.files("H:\\Statistiken\\")
data_path <- "H:/Statistiken"

# find the file that has the material and machine in its name

file_pattern <- "BlutDxI"


file_name <- files[grep(file_pattern, files)]
full_path <- file.path(data_path, file_name)

head1 <- read_excel(full_path, col_names = TRUE) |>  names()
head2 <- read_excel(full_path, skip = 1, col_names = TRUE)  |>  names()
head2[1:7] <- c("a", "b", "c", "d", "e", "f", "g")

head <- paste0(head2, sep = "_", head1)
global.dxi.data <- read_excel(full_path, skip = 2, col_names = head, col_types =
                            c(
                              "text",
                              "numeric",
                              "skip",
                              "skip",
                              "date",
                              "text",
                              "text",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric"
                            ))

global.dxi.data <- global.dxi.data |> filter(!grepl("Tagesnummer", global.dxi.data$a_Tagesnummer))
global.dxi.data <- global.dxi.data |> filter(!is.na(a_Tagesnummer))


# change day-number to date and reorder column
global.dxi.data$Datum <- ymd(substr(global.dxi.data$a_Tagesnummer, 1, 10))

global.dxi.data <- global.dxi.data |> relocate(Datum, .before = 6)   


# create new data frame, sort analysis-names in one column (Bezeichnung), 
#code into another (Methode) and results into a third (Werte)
dxi.analy.pivot <- global.dxi.data |> pivot_longer(
  cols = !(a_Tagesnummer:Datum), 
  names_to = c("Bezeichnung","Methode"),
  names_sep = "_",
  values_to = "Werte",
  values_drop_na = TRUE)

#left join to get tax point information from tariff, remove junk data, save tidy data
tidy.dxi.data <- left_join(dxi.analy.pivot, tarif.scales, by = c("Methode"), keep = FALSE, multiple = "any")

tidy.dxi.data <- subset(tidy.dxi.data, select = -c(Tagesnummer))

#call age
tidy.dxi.data$Alter <- year(tidy.dxi.data$Datum) - year(tidy.dxi.data$e_Geb.datum) - (month(tidy.dxi.data$Datum) < month(tidy.dxi.data$e_Geb.datum) | (month(tidy.dxi.data$Datum) == month(tidy.dxi.data$e_Geb.datum) & day(tidy.dxi.data$Datum) < day(tidy.dxi.data$e_Geb.datum)))

tidy.dxi.data <- tidy.dxi.data |> relocate(Alter, .before = f_Geschl.)


write_excel_csv(tidy.dxi.data, "tidy_DxI_dataTxp.csv")

```
  



```{r flex DxI.tidy.data into summary, echo=FALSE, message=FALSE, warning=FALSE}
tidy.dxi.data$Year_Month <- format(ymd(tidy.dxi.data$Datum), "%Y-%m")


dxi.sum.data <- tidy.dxi.data |> 
  group_by(Year_Month) |> 
  summarize(DxI_TxpUmsatz = sum(ifelse(is.na(Taxpkt.), 0, Taxpkt.)),
            DxI_Auftraege = n_distinct(a_Tagesnummer),
            Anz_Patienten = n_distinct(b_Fallnummer)
            )
dxi.sum.data$TxpUmsatz <- dxi.sum.data$DxI_TxpUmsatz + dxi.sum.data$DxI_Auftraege * 10
dxi.sum.data$DxI_TxpUmsatz <- dxi.sum.data$DxI_TxpUmsatz + dxi.sum.data$DxI_Auftraege * 10
dxi.sum.data <- dxi.sum.data |> relocate(TxpUmsatz,  .before = DxI_TxpUmsatz)

dxi.sum.data |> flextable() |> 
  theme_vanilla() |> 
  bg(bg = "grey", part = "header") |> 
  mk_par(j = 2,
          value = as_paragraph(
            linerange(value = DxI_TxpUmsatz, max = max(DxI_TxpUmsatz), height = .15)
            ),
  part = "body") |> 
  set_header_labels(
    DxI_TxpUmsatz = " ",
    DxI_Auftraege = "Auftraege",
    Anz_Patienten = "Patienten (n)"
  ) |> merge_at(j = c(2, 3), part = "header") |> 
  align(align = "center", part = "all")|>
  set_table_properties(width = 0.8, layout = "autofit") |> 
  colformat_date(fmt_date = "%m/%Y") 

```

<br>

<br>

#### DxI800: Anzahl der einzelnen Analysen pro Quartal

```{r 2022 DxI analysis, echo=FALSE, message=FALSE, warning=FALSE}
dxi.sum.method <- tidy.dxi.data |> 
     mutate(Quarter = paste0("Q", quarter(floor_date(Datum, "quarter"))),
            Year = year(Datum)) |> 
     filter(Year == 2022) |> 
     summarise(
         Analysen = n(),
         .by = c(Quarter, Year, Bezeichnung)
     ) |> 
     pivot_wider(
         names_from = c(Quarter, Year), 
         values_from = Analysen, 
         # names_glue = "{Quarter}_{Year}",
         names_sort = TRUE
     )




dxi.sum.method |> 
  arrange(desc(Q4_2022)) |> 
  flextable() |> 
  theme_vanilla() |> 
  bg(bg = "grey", part = "header") |> 
  add_header_row(
    values = c("Methoden", "n in 2022"),
    colwidths = c(1, 4)) |> 
    theme_box() |>  
  set_header_labels(
    Q1_2022 = "Q1",
    Q2_2022 = "Q2",
    Q3_2022 = "Q3",
    Q4_2022 = "Q4"
  ) |> 
  align(align = "center", part = "all")|>
  set_table_properties(width = 0.8, layout = "autofit")


```
\newpage

### Zusammenfassung Hochdurchsatz

```{r summing_up_CoreLab, echo=FALSE, message=FALSE, warning=FALSE}
library(dplyr)
library(stringr)

combined.data <- bind_rows(
  AU.sum.data,
  dxi.sum.data,
  )
sum.data <- combined.data |> 
  group_by(Year_Month) |> 
  summarize(
    TxpUmsatz_KC = sum(ifelse(is.na(TxpUmsatz), 0, TxpUmsatz)),
    Auftraege_KC = sum(sum(ifelse(is.na(AU_Auftraege), 0, AU_Auftraege)), 
                      sum(ifelse(is.na(DxI_Auftraege), 0, DxI_Auftraege))),
    Anz_Patienten_sum = sum(ifelse(is.na(Anz_Patienten), 0, Anz_Patienten
    )))

sum.data$TxpUmsatz <- sum.data$TxpUmsatz_KC
sum.data <- sum.data |> relocate(TxpUmsatz,  .before = TxpUmsatz_KC)
sum.data$Year <- format(ym(sum.data$Year_Month), "%Y")
sum.data <- sum.data |> relocate(Year,  .before = Year_Month) 





sum.data.22 <- sum.data |> filter(Year == "2022")|> subset(select = -c(Year))
sum.data.22 <-  rbind(sum.data.22, c("Total", colSums(sum.data.22[,2:5]))) 
sum.data.22$TxpUmsatz <- as.numeric(sum.data.22$TxpUmsatz)
sum.data.22$TxpUmsatz_KC <- as.numeric(sum.data.22$TxpUmsatz_KC)



sum.data.22 |>  
  flextable() |>  
  theme_vanilla() |> 
  bg(bg = "grey", part = "header") |> 
  mk_par(j = 2,
         value = as_paragraph(
           linerange(value = TxpUmsatz_KC, max = max(TxpUmsatz_KC), height = .15)
         ),
         part = "body") |> 
  set_header_labels(
    TxpUmsatz = "TxpUmsatz -Hochdurchsatz-",
    Auftraege_KC = "Auftraege",
    Anz_Patienten_sum = "Patienten (n)"
  ) |> 
  merge_at(j = c(2, 3), part = "header") |> 
  align(align = "center", part = "all")|>
  set_table_properties(width = 0.8, layout = "autofit") |> 
  colformat_date(fmt_date = "%m/%Y") 


```

\newpage
  
### Spez. Chemie  

#### BNII Nephelometrie: Taxpunkt-Umsatz & Auftragszahlen  

```{r tidyup_BNII_data, echo=FALSE, message=FALSE, warning=FALSE}
# files <- list.files("H:\\Statistiken\\")
# 
# 
# tarif.scales <- read_excel("H:\\Statistiken\\UmsatzStatistik.xlsx", col_types = c(
#   "text",
#   "text",
#   "skip",
#   "skip",
#   "skip",
#   "skip",
#   "numeric",
#   "skip",
#   "numeric"))


# list all files in the directory
files <- list.files("H:\\Statistiken\\")
data_path <- "H:/Statistiken"

# find the file that has the materila and machine in its name

file_pattern <- "BNII"


file_name <- files[grep(file_pattern, files)]
full_path <- file.path(data_path, file_name)

head1 <- read_excel(full_path, col_names = TRUE) |>  names()
head2 <- read_excel(full_path, skip = 1, col_names = TRUE)  |>  names()
head2[1:7] <- c("a", "b", "c", "d", "e", "f", "g")

head <- paste0(head2, sep = "_", head1)
global.bn.data <- read_excel(full_path, skip = 2, col_names = head, col_types =
                                c(
                                  "text",
                                  "numeric",
                                  "skip",
                                  "skip",
                                  "date",
                                  "text",
                                  "text",
                                  "numeric",
                                  "numeric",
                                  "numeric",
                                  "numeric",
                                  "numeric",
                                  "numeric",
                                  "numeric",
                                  "numeric",
                                  "numeric",
                                  "numeric",
                                  "numeric",
                                  "numeric",
                                  "numeric",
                                  "numeric",
                                  "numeric",
                                  "numeric",
                                  "numeric",
                                  "numeric",
                                  "numeric",
                                  "numeric",
                                  "numeric",
                                  "numeric",
                                  "numeric",
                                  "numeric",
                                  "numeric",
                                  "numeric"
                                ))

global.bn.data <- global.bn.data |> filter(!grepl("Tagesnummer", global.bn.data$a_Tagesnummer))
global.bn.data <- global.bn.data |> filter(!is.na(a_Tagesnummer))


# change day-number to date and reorder column
global.bn.data$Datum <- ymd(substr(global.bn.data$a_Tagesnummer, 1, 10))

global.bn.data <- global.bn.data |> relocate(Datum, .before = 6)   


# create new data frame, sort analysis-names in one column (Bezeichnung), 
#code into another (Methode) and results into a third (Werte)
bn.analy.pivot <- global.bn.data |> pivot_longer(
  cols = !(a_Tagesnummer:Datum), 
  names_to = c("Bezeichnung","Methode"),
  names_sep = "_",
  values_to = "Werte",
  values_drop_na = TRUE)

#left join to get tax point information from tariff, remove junk data, save tidy data
tidy.bn.data <- left_join(bn.analy.pivot, tarif.scales, by = c("Methode"), keep = FALSE, multiple = "any")

tidy.bn.data <- subset(tidy.bn.data, select = -c(Tagesnummer))

#call age
tidy.bn.data$Alter <- year(tidy.bn.data$Datum) - year(tidy.bn.data$e_Geb.datum) - (month(tidy.bn.data$Datum) < month(tidy.bn.data$e_Geb.datum) | (month(tidy.bn.data$Datum) == month(tidy.bn.data$e_Geb.datum) & day(tidy.bn.data$Datum) < day(tidy.bn.data$e_Geb.datum)))

tidy.bn.data <- tidy.bn.data |> relocate(Alter, .before = f_Geschl.)


write_excel_csv(tidy.bn.data, "tidy_bn_dataTxp.csv")

```
  

```{r flex BNII.tidy.data into summary, echo=FALSE, message=FALSE, warning=FALSE}
tidy.bn.data$Year_Month <- format(ymd(tidy.bn.data$Datum), "%Y-%m")


bn.sum.data <- tidy.bn.data |> 
  group_by(Year_Month) |> 
  summarize(bn_TxpUmsatz = sum(ifelse(is.na(Taxpkt.), 0, Taxpkt.)),
            bn_Auftraege = n_distinct(a_Tagesnummer),
            Anz_Patienten = n_distinct(b_Fallnummer)
  )
bn.sum.data$TxpUmsatz <- bn.sum.data$bn_TxpUmsatz + bn.sum.data$bn_Auftraege * 10
bn.sum.data$bn_TxpUmsatz <- bn.sum.data$bn_TxpUmsatz + bn.sum.data$bn_Auftraege * 10
bn.sum.data <- bn.sum.data |> relocate(TxpUmsatz,  .before = bn_TxpUmsatz)

bn.sum.data |> flextable() |> 
  theme_vanilla() |> 
  bg(bg = "grey", part = "header") |> 
  mk_par(j = 2,
         value = as_paragraph(
           linerange(value = bn_TxpUmsatz, max = max(bn_TxpUmsatz), height = .15)
         ),
         part = "body") |> 
  set_header_labels(
    bn_TxpUmsatz = " ",
    bn_Auftraege = "Auftraege",
    Anz_Patienten = "Patienten (n)"
  ) |> merge_at(j = c(2, 3), part = "header") |> 
  align(align = "center", part = "all")|>
  set_table_properties(width = 0.8, layout = "autofit") |> 
  colformat_date(fmt_date = "%m/%Y") 

```

<br>

<br>

#### BNII: Anzahl der einzelnen Analysen pro Quartal

```{r 2022 BNII analysis, echo=FALSE, message=FALSE, warning=FALSE}
bn.sum.method <- tidy.bn.data |> 
  mutate(Quarter = paste0("Q", quarter(floor_date(Datum, "quarter"))),
         Year = year(Datum)) |> 
  filter(Year == 2022) |> 
  summarise(
    Analysen = n(),
    .by = c(Quarter, Year, Bezeichnung)
  ) |> 
  pivot_wider(
    names_from = c(Quarter, Year), 
    values_from = Analysen, 
    names_sort = TRUE
  )




bn.sum.method |> 
  arrange(desc(Q4_2022)) |>
  flextable() |> 
  theme_vanilla() |> 
  bg(bg = "grey", part = "header") |> 
  add_header_row(
    values = c("Methoden", "n in 2022"),
    colwidths = c(1, 4)) |> 
  theme_box() |>  
  set_header_labels(
    Q1_2022 = "Q1",
    Q2_2022 = "Q2",
    Q3_2022 = "Q3",
    Q4_2022 = "Q4"
  ) |> 
  align(align = "center", part = "all")|>
  set_table_properties(width = 0.8, layout = "autofit")



```
\newpage
#### Protein-Elektrophorese & Immun-Fixationen & Iso-Enzym-Elektrophoresen: Taxpunkt-Umsatz & Auftragszahlen  
```{r tidyup_EPIFE_data, echo=FALSE, message=FALSE, warning=FALSE}



# tarif.scales <- read_excel("H:\\Statistiken\\UmsatzStatistik.xlsx", col_types = c(
#   "text",
#   "text",
#   "skip",
#   "skip",
#   "skip",
#   "skip",
#   "numeric",
#   "skip",
#   "numeric"))


# list all files in the directory
files <- list.files("H:\\Statistiken\\")
data_path <- "H:/Statistiken"

# find the file that has the materila and machine in its name

file_pattern <- "EPIFE"


file_name <- files[grep(file_pattern, files)]
full_path <- file.path(data_path, file_name)

head1 <- read_excel(full_path, col_names = TRUE) |>  names()
head2 <- read_excel(full_path, skip = 1, col_names = TRUE)  |>  names()
head2[1:8] <- c("a", "b", "c", "d", "e", "f", "g", "h")

head <- paste0(head2, sep = "_", head1)
global.ep.data <- read_excel(full_path, skip = 2, col_names = head, col_types =
                                 c(
                                   "text",
                                   "skip",
                                   "numeric",
                                   "skip",
                                   "skip",
                                   "date",
                                   "text",
                                   "text",
                                   "text",
                                   "text",
                                   "text",
                                   "text",
                                   "text",
                                   "text",
                                   "text",
                                   "text",
                                   "text",
                                   "text",
                                   "text",
                                   "text"
                                 ))
library(dplyr)
library(stringr)

global.ep.data <- global.ep.data  |> 
  mutate_all(~ str_replace_all(., c("s.unten" = "1", 
                                    "folgt" = "1", 
                                    "s. unten" ="1", 
                                    "negative" ="1", 
                                    "fraglich" = "1",
                                    "s.u." = "1", 
                                    " Nachweis von Chylomikronen" ="1",
                                    "keine Chylomikronen" = "1"
                                    ))) |> as.data.frame() 


global.ep.data <- global.ep.data |> filter(!grepl("Tagesnummer", global.ep.data$a_Tagesnummer))
global.ep.data <- global.ep.data |> filter(!is.na(a_Tagesnummer))


# change day-number to date and reorder column
global.ep.data$Datum <- ymd(substr(global.ep.data$a_Tagesnummer, 1, 10))

global.ep.data <- global.ep.data |> relocate(Datum, .before = 6)   


# create new data frame, sort analysis-names in one column (Bezeichnung), 
#code into another (Methode) and results into a third (Werte)
ep.analy.pivot <- global.ep.data |> pivot_longer(
  cols = !(a_Tagesnummer:Datum), 
  names_to = c("Bezeichnung","Methode"),
  names_sep = "_",
  values_to = "Werte",
  values_drop_na = TRUE)

#left join to get tax point information from tariff, remove junk data, save tidy data
tidy.ep.data <- left_join(ep.analy.pivot, tarif.scales, by = c("Methode"), keep = FALSE, multiple = "any")

tidy.ep.data <- subset(tidy.ep.data, select = -c(Tagesnummer))

#call age
tidy.ep.data$Alter <-
  year(tidy.ep.data$Datum) - year(tidy.ep.data$f_Geb.datum) - (
    month(tidy.ep.data$Datum) < month(tidy.ep.data$f_Geb.datum) |
      (
        month(tidy.ep.data$Datum) == month(tidy.ep.data$f_Geb.datum) &
          day(tidy.ep.data$Datum) < day(tidy.ep.data$f_Geb.datum)
      )
  )

tidy.ep.data <- tidy.ep.data |> relocate(Alter, .before = g_Geschl.)


write_excel_csv(tidy.ep.data, "tidy_ep_dataTxp.csv")

```

```{r flex_ep.tidy.data_into_summary, echo=FALSE, message=FALSE, warning=FALSE}

tidy.ep.data$Year_Month <- format(ymd(tidy.ep.data$Datum), "%Y-%m")

ep.sum.data <- tidy.ep.data |> 
  group_by(Year_Month) |> 
  summarize(ep_TxpUmsatz = sum(ifelse(is.na(Taxpkt.), 0, Taxpkt.)),
            ep_Auftraege = n_distinct(a_Tagesnummer),
            Anz_Patienten = n_distinct(c_Fallnummer)
  )



ep.sum.data$TxpUmsatz <- ep.sum.data$ep_TxpUmsatz + ep.sum.data$ep_Auftraege * 10
ep.sum.data$ep_TxpUmsatz <- ep.sum.data$ep_TxpUmsatz + ep.sum.data$ep_Auftraege * 10
ep.sum.data <- ep.sum.data |> relocate(TxpUmsatz,  .before = ep_TxpUmsatz)

ep.sum.data |> flextable() |> 
  theme_vanilla() |> 
  bg(bg = "grey", part = "header") |> 
  mk_par(j = 2,
         value = as_paragraph(
           linerange(value = ep_TxpUmsatz, max = max(ep_TxpUmsatz), height = .15)
         ),
         part = "body") |> 
  set_header_labels(
    ep_TxpUmsatz = " ",
    ep_Auftraege = "Auftraege",
    Anz_Patienten = "Patienten (n)"
  ) |> merge_at(j = c(2, 3), part = "header") |> 
  align(align = "center", part = "all")|>
  set_table_properties(width = 0.8, layout = "autofit") |> 
  colformat_date(fmt_date = "%m/%Y") 

```

<br>

<br>

#### EP & IEF: Anzahl der einzelnen Analysen pro Quartal

```{r 2022 ep analysis, echo=FALSE, message=FALSE, warning=FALSE}
ep.sum.method <- tidy.ep.data |> 
  mutate(Quarter = paste0("Q", quarter(floor_date(Datum, "quarter"))),
         Year = year(Datum)) |> 
  filter(Year == 2022) |> 
  summarise(
    Analysen = n(),
    .by = c(Quarter, Year, Bezeichnung)
  ) |> 
  pivot_wider(
    names_from = c(Quarter, Year), 
    values_from = Analysen, 
    names_sort = TRUE
  )




ep.sum.method |> 
  arrange(desc(Q4_2022)) |>
  flextable() |> 
  theme_vanilla() |> 
  bg(bg = "grey", part = "header") |> 
  add_header_row(
    values = c("Methoden", "n in 2022"),
    colwidths = c(1, 4)) |> 
  theme_box() |>  
  set_header_labels(
    Q1_2022 = "Q1",
    Q2_2022 = "Q2",
    Q3_2022 = "Q3",
    Q4_2022 = "Q4"
  ) |> 
  align(align = "center", part = "all")|>
  set_table_properties(width = 0.8, layout = "autofit")





```

\newpage

#### HPLC: Taxpunkt-Umsatz & Auftragszahlen   

```{r tidyup_HPLC_data, echo=FALSE, message=FALSE, warning=FALSE}
# files <- list.files("H:\\Statistiken\\")


# tarif.scales <- read_excel("H:\\Statistiken\\UmsatzStatistik.xlsx", col_types = c(
#   "text",
#   "text",
#   "skip",
#   "skip",
#   "skip",
#   "skip",
#   "numeric",
#   "skip",
#   "numeric"))


# list all files in the directory
files <- list.files("H:\\Statistiken\\")
data_path <- "H:/Statistiken"

# find the file that has the materila and machine in its name

file_pattern <- "HPLC"


file_name <- files[grep(file_pattern, files)]
full_path <- file.path(data_path, file_name)

head1 <- read_excel(full_path, col_names = TRUE) |>  names()
head2 <- read_excel(full_path, skip = 1, col_names = TRUE)  |>  names()
head2[1:7] <- c("a", "b", "c", "d", "e", "f", "g")

head <- paste0(head2, sep = "_", head1)
global.hplc.data <- read_excel(full_path, skip = 2, col_names = head, col_types =
                               c(
                                 "text",
                                 "numeric",
                                 "skip",
                                 "skip",
                                 "date",
                                 "text",
                                 "text",
                                 "numeric",
                                 "numeric",
                                 "numeric",
                                 "numeric",
                                 "numeric",
                                 "numeric",
                                 "numeric",
                                 "numeric",
                                 "numeric",
                                 "numeric",
                                 "numeric",
                                 "numeric",
                                 "numeric",
                                 "numeric",
                                 "numeric",
                                 "numeric",
                                 "numeric",
                                 "numeric"
                               ))

global.hplc.data <- global.hplc.data |> filter(!grepl("Tagesnummer", global.hplc.data$a_Tagesnummer))
global.hplc.data <- global.hplc.data |> filter(!is.na(a_Tagesnummer))


# change day-number to date and reorder column
global.hplc.data$Datum <- ymd(substr(global.hplc.data$a_Tagesnummer, 1, 10))

global.hplc.data <- global.hplc.data |> relocate(Datum, .before = 6)   


# create new data frame, sort analysis-names in one column (Bezeichnung), 
#code into another (Methode) and results into a third (Werte)
hplc.analy.pivot <- global.hplc.data |> pivot_longer(
  cols = !(a_Tagesnummer:Datum), 
  names_to = c("Bezeichnung","Methode"),
  names_sep = "_",
  values_to = "Werte",
  values_drop_na = TRUE)

#left join to get tax point information from tariff, remove junk data, save tidy data
tidy.hplc.data <- left_join(hplc.analy.pivot, tarif.scales, by = c("Methode"), keep = FALSE, multiple = "any")

tidy.hplc.data <- subset(tidy.hplc.data, select = -c(Tagesnummer))

#call age
tidy.hplc.data$Alter <-
  year(tidy.hplc.data$Datum) - year(tidy.hplc.data$e_Geb.datum) - (
    month(tidy.hplc.data$Datum) < month(tidy.hplc.data$e_Geb.datum) |
      (
        month(tidy.hplc.data$Datum) == month(tidy.hplc.data$e_Geb.datum) &
          day(tidy.hplc.data$Datum) < day(tidy.hplc.data$e_Geb.datum)
      )
  )

tidy.hplc.data <- tidy.hplc.data |> relocate(Alter, .before = f_Geschl.)


write_excel_csv(tidy.hplc.data, "tidy_hplc_dataTxp.csv")

```
  

```{r flex HPLC.tidy.data into summary, echo=FALSE, message=FALSE, warning=FALSE}
tidy.hplc.data$Year_Month <- format(ymd(tidy.hplc.data$Datum), "%Y-%m")

hplc.sum.data <- tidy.hplc.data |> 
  group_by(Year_Month) |> 
  summarize(hplc_TxpUmsatz = sum(ifelse(is.na(Taxpkt.), 0, Taxpkt.)),
            hplc_Auftraege = n_distinct(a_Tagesnummer),
            Anz_Patienten = n_distinct(b_Fallnummer)
  )
hplc.sum.data$TxpUmsatz <- hplc.sum.data$hplc_TxpUmsatz + hplc.sum.data$hplc_Auftraege * 10
hplc.sum.data$hplc_TxpUmsatz <- hplc.sum.data$hplc_TxpUmsatz + hplc.sum.data$hplc_Auftraege * 10
hplc.sum.data <- hplc.sum.data |> relocate(TxpUmsatz,  .before = hplc_TxpUmsatz)

hplc.sum.data |> flextable() |> 
  theme_vanilla() |> 
  bg(bg = "grey", part = "header") |> 
  mk_par(j = 2,
         value = as_paragraph(
           linerange(value = hplc_TxpUmsatz, max = max(hplc_TxpUmsatz), height = .15)
         ),
         part = "body") |> 
  set_header_labels(
    hplc_TxpUmsatz = " ",
    hplc_Auftraege = "Auftraege",
    Anz_Patienten = "Patienten (n)"
  ) |> merge_at(j = c(2, 3), part = "header") |> 
  align(align = "center", part = "all")|>
  set_table_properties(width = 0.8, layout = "autofit") |> 
  colformat_date(fmt_date = "%m/%Y")  

```
<br>

<br>

#### HPLC 2021: Anzahl der einzelnen Analysen pro Quartal

```{r 2022 HPLC analysis, echo=FALSE, message=FALSE, warning=FALSE}
hplc.sum.method <- tidy.hplc.data |> 
  mutate(Quarter = paste0("Q", quarter(floor_date(Datum, "quarter"))),
         Year = year(Datum)) |> 
  filter(Year == 2022) |> 
  summarise(
    Analysen = n(),
    .by = c(Quarter, Year, Bezeichnung)
  ) |> 
  pivot_wider(
    names_from = c(Quarter, Year), 
    values_from = Analysen, 
    names_sort = TRUE
  )




hplc.sum.method |> 
  arrange(desc(Q4_2022)) |>
  flextable() |> 
  theme_vanilla() |> 
  bg(bg = "grey", part = "header") |> 
  add_header_row(
    values = c("Methoden", "n in 2022"),
    colwidths = c(1, 4)) |> 
  theme_box() |>  
  set_header_labels(
    Q1_2022 = "Q1",
    Q2_2022 = "Q2",
    Q3_2022 = "Q3",
    Q4_2022 = "Q4"
  ) |> 
  align(align = "center", part = "all")|>
  set_table_properties(width = 0.8, layout = "autofit")




```
<br>

<br>

#### HPLC 2021: Anzahl der einzelnen Analysen pro Quartal

```{r 2021 HPLC analysis, echo=FALSE, message=FALSE, warning=FALSE}
hplc.sum.method <- tidy.hplc.data |> 
  mutate(Quarter = paste0("Q", quarter(floor_date(Datum, "quarter"))),
         Year = year(Datum)) |> 
  filter(Year == 2021) |> 
  summarise(
    Analysen = n(),
    .by = c(Quarter, Year, Bezeichnung)
  ) |> 
  pivot_wider(
    names_from = c(Quarter, Year), 
    values_from = Analysen, 
    names_sort = TRUE
  )




hplc.sum.method |> 
  arrange(desc(Q4_2021)) |>
  flextable() |> 
  theme_vanilla() |> 
  bg(bg = "grey", part = "header") |> 
  add_header_row(
    values = c("Methoden", "n in 2021"),
    colwidths = c(1, 4)) |> 
  theme_box() |>  
  set_header_labels(
    Q1_2021 = "Q1",
    Q2_2021 = "Q2",
    Q3_2021 = "Q3",
    Q4_2021 = "Q4"
  ) |> 
  align(align = "center", part = "all")|>
  set_table_properties(width = 0.8, layout = "autofit")




```

\newpage

#### Lc-MS/MS: Taxpunkt-Umsatz & Auftragszahlen    

```{r tidyup_LcMS_data, echo=FALSE, message=FALSE, warning=FALSE}
# files <- list.files("H:\\Statistiken\\")


# tarif.scales <- read_excel("H:\\Statistiken\\UmsatzStatistik.xlsx", col_types = c(
#   "text",
#   "text",
#   "skip",
#   "skip",
#   "skip",
#   "skip",
#   "numeric",
#   "skip",
#   "numeric"))


# list all files in the directory
files <- list.files("H:\\Statistiken\\")
data_path <- "H:/Statistiken"

# find the file that has the materila and machine in its name

file_pattern <- "LcMSMS"


file_name <- files[grep(file_pattern, files)]
full_path <- file.path(data_path, file_name)

head1 <- read_excel(full_path, col_names = TRUE) |>  names()
head2 <- read_excel(full_path, skip = 1, col_names = TRUE)  |>  names()
head2[1:8] <- c("a", "b", "c", "d", "e", "f", "g", "h")

head <- paste0(head2, sep = "_", head1)
global.lcms.data <- read_excel(full_path, skip = 2, col_names = head, col_types =
                                 c(
                                   "text",
                                   "skip",
                                   "numeric",
                                   "skip",
                                   "skip",
                                   "date",
                                   "text",
                                   "text",
                                   "numeric",
                                   "numeric",
                                   "numeric",
                                   "numeric",
                                   "numeric",
                                   "numeric",
                                   "numeric",
                                   "numeric",
                                   "numeric",
                                   "numeric"
                                 ))

global.lcms.data <- global.lcms.data |> filter(!grepl("Tagesnummer", global.lcms.data$a_Tagesnummer))
global.lcms.data <- global.lcms.data |> filter(!is.na(a_Tagesnummer))


# change day-number to date and reorder column
global.lcms.data$Datum <- ymd(substr(global.lcms.data$a_Tagesnummer, 1, 10))

global.lcms.data <- global.lcms.data |> relocate(Datum, .before = 6)   


# create new data frame, sort analysis-names in one column (Bezeichnung), 
#code into another (Methode) and results into a third (Werte)
lcms.analy.pivot <- global.lcms.data |> pivot_longer(
  cols = !(a_Tagesnummer:Datum), 
  names_to = c("Bezeichnung","Methode"),
  names_sep = "_",
  values_to = "Werte",
  values_drop_na = TRUE)

#left join to get tax point information from tariff, remove junk data, save tidy data
tidy.lcms.data <- left_join(lcms.analy.pivot, tarif.scales, by = c("Methode"), keep = FALSE, multiple = "any")

tidy.lcms.data <- subset(tidy.lcms.data, select = -c(Tagesnummer))

#call age
tidy.lcms.data$Alter <-
  year(tidy.lcms.data$Datum) - year(tidy.lcms.data$f_Geb.datum) - (
    month(tidy.lcms.data$Datum) < month(tidy.lcms.data$f_Geb.datum) |
      (
        month(tidy.lcms.data$Datum) == month(tidy.lcms.data$f_Geb.datum) &
          day(tidy.lcms.data$Datum) < day(tidy.lcms.data$f_Geb.datum)
      )
  )

tidy.lcms.data <- tidy.lcms.data |> relocate(Alter, .before = g_Geschl.)


write_excel_csv(tidy.lcms.data, "tidy_lcms_dataTxp.csv")

```
  

```{r flex LCMS.tidy.data into summary, echo=FALSE, message=FALSE, warning=FALSE}
tidy.lcms.data$Year_Month <- format(ymd(tidy.lcms.data$Datum), "%Y-%m")

lcms.sum.data <- tidy.lcms.data |> 
  group_by(Year_Month) |> 
  summarize(lcms_TxpUmsatz = sum(ifelse(is.na(Taxpkt.), 0, Taxpkt.)),
            lcms_Auftraege = n_distinct(a_Tagesnummer),
            Anz_Patienten = n_distinct(c_Fallnummer)
  )
lcms.sum.data$TxpUmsatz <- lcms.sum.data$lcms_TxpUmsatz + lcms.sum.data$lcms_Auftraege * 10
lcms.sum.data$lcms_TxpUmsatz <- lcms.sum.data$lcms_TxpUmsatz + lcms.sum.data$lcms_Auftraege * 10
lcms.sum.data <- lcms.sum.data |> relocate(TxpUmsatz,  .before = lcms_TxpUmsatz)

lcms.sum.data |> flextable() |> 
  theme_vanilla() |> 
  bg(bg = "grey", part = "header") |> 
  mk_par(j = 2,
         value = as_paragraph(
           linerange(value = lcms_TxpUmsatz, max = max(lcms_TxpUmsatz), height = .15)
         ),
         part = "body") |> 
  set_header_labels(
    lcms_TxpUmsatz = " ",
    lcms_Auftraege = "Auftraege",
    Anz_Patienten = "Patienten (n)"
  ) |> merge_at(j = c(2, 3), part = "header") |> 
  align(align = "center", part = "all")|>
  set_table_properties(width = 0.8, layout = "autofit") |> 
  colformat_date(fmt_date = "%m/%Y") 

```
<br>

<br>

#### LcMS/MS 2022: Anzahl der einzelnen Analysen pro Quartal

```{r 2022 LCMS analysis, echo=FALSE, message=FALSE, warning=FALSE}
lcms.sum.method <- tidy.lcms.data |> 
  mutate(Quarter = paste0("Q", quarter(floor_date(Datum, "quarter"))),
         Year = year(Datum)) |> 
  filter(Year == 2022) |> 
  summarise(
    Analysen = n(),
    .by = c(Quarter, Year, Bezeichnung)
  ) |> 
  pivot_wider(
    names_from = c(Quarter, Year), 
    values_from = Analysen, 
    names_sort = TRUE
  )




lcms.sum.method |> 
  arrange(desc(Q4_2022)) |>
  flextable() |> 
  theme_vanilla() |> 
  bg(bg = "grey", part = "header") |> 
  add_header_row(
    values = c("Methoden", "n in 2022"),
    colwidths = c(1, 4)) |> 
  theme_box() |>  
  set_header_labels(
    Q1_2022 = "Q1",
    Q2_2022 = "Q2",
    Q3_2022 = "Q3",
    Q4_2022 = "Q4"
  ) |> 
  align(align = "center", part = "all")|>
  set_table_properties(width = 0.8, layout = "autofit")





```

<br>

<br>

#### LcMS/MS 2021: Anzahl der einzelnen Analysen pro Quartal

```{r 2021 LCMS analysis, echo=FALSE, message=FALSE, warning=FALSE}
lcms.sum.method <- tidy.lcms.data |> 
  mutate(Quarter = paste0("Q", quarter(floor_date(Datum, "quarter"))),
         Year = year(Datum)) |> 
  filter(Year == 2021) |> 
  summarise(
    Analysen = n(),
    .by = c(Quarter, Year, Bezeichnung)
  ) |> 
  pivot_wider(
    names_from = c(Quarter, Year), 
    values_from = Analysen, 
    names_sort = TRUE
  )




lcms.sum.method |> 
  arrange(desc(Q4_2021)) |>
  flextable() |> 
  theme_vanilla() |> 
  bg(bg = "grey", part = "header") |> 
  add_header_row(
    values = c("Methoden", "n in 2021"),
    colwidths = c(1, 4)) |> 
  theme_box() |>  
  set_header_labels(
    Q1_2021 = "Q1",
    Q2_2021 = "Q2",
    Q3_2021 = "Q3",
    Q4_2021 = "Q4"
  ) |> 
  align(align = "center", part = "all")|>
  set_table_properties(width = 0.8, layout = "autofit")




```
\newpage
#### Hand-Methoden: Taxpunkt-Umsatz & Auftragszahlen    

```{r tidyup_VH4_data, echo=FALSE, message=FALSE, warning=FALSE}
# files <- list.files("H:\\Statistiken\\")
# 
# 
# tarif.scales <- read_excel("H:\\Statistiken\\UmsatzStatistik.xlsx", col_types = c(
#   "text",
#   "text",
#   "skip",
#   "skip",
#   "skip",
#   "skip",
#   "numeric",
#   "skip",
#   "numeric",
#   "skip"))


# list all files in the directory
files <- list.files("H:\\Statistiken\\")
data_path <- "H:/Statistiken"

# find the file that has the materila and machine in its name

file_pattern <- "VH4"


file_name <- files[grep(file_pattern, files)]
full_path <- file.path(data_path, file_name)

head1 <- read_excel(full_path, col_names = TRUE) |>  names()
head2 <- read_excel(full_path, skip = 1, col_names = TRUE)  |>  names()
head2[1:7] <- c("a", "b", "c", "d", "e", "f", "g")

head <- paste0(head2, sep = "_", head1)
global.vh.data <- read_excel(full_path, skip = 2, col_names = head, col_types =
                               c(
                                 "text",
                                 "numeric",
                                 "skip",
                                 "skip",
                                 "date",
                                 "text",
                                 "text",
                                 "numeric",
                                 "numeric",
                                 "numeric",
                                 "numeric",
                                 "numeric",
                                 "numeric",
                                 "numeric",
                                 "numeric",
                                 "numeric",
                                 "numeric",
                                 "numeric",
                                 "numeric",
                                 "numeric",
                                 "numeric",
                                 "numeric",
                                 "numeric",
                                 "numeric",
                                 "numeric",
                                 "numeric",
                                 "numeric",
                                 "numeric"
                               ))

global.vh.data <- global.vh.data |> filter(!grepl("Tagesnummer", global.vh.data$a_Tagesnummer))
global.vh.data <- global.vh.data |> filter(!is.na(a_Tagesnummer))


# change day-number to date and reorder column
global.vh.data$Datum <- ymd(substr(global.vh.data$a_Tagesnummer, 1, 10))

global.vh.data <- global.vh.data |> relocate(Datum, .before = 6)   


# create new data frame, sort analysis-names in one column (Bezeichnung), 
#code into another (Methode) and results into a third (Werte)
vh.analy.pivot <- global.vh.data |> pivot_longer(
  cols = !(a_Tagesnummer:Datum), 
  names_to = c("Bezeichnung","Methode"),
  names_sep = "_",
  values_to = "Werte",
  values_drop_na = TRUE)

#left join to get tax point information from tariff, remove junk data, save tidy data
tidy.vh.data <- left_join(vh.analy.pivot, tarif.scales, by = c("Methode"), keep = FALSE, multiple = "any")

tidy.vh.data <- subset(tidy.vh.data, select = -c(Tagesnummer))

#call age
tidy.vh.data$Alter <- year(tidy.vh.data$Datum) - year(tidy.vh.data$e_Geb.datum) - (month(tidy.vh.data$Datum) < month(tidy.vh.data$e_Geb.datum) | (month(tidy.vh.data$Datum) == month(tidy.vh.data$e_Geb.datum) & day(tidy.vh.data$Datum) < day(tidy.vh.data$e_Geb.datum)))

tidy.vh.data <- tidy.vh.data |> relocate(Alter, .before = f_Geschl.)


write_excel_csv(tidy.vh.data, "tidy_vh_dataTxp.csv")

```


```{r flex vh4.tidy.data into summary, echo=FALSE, message=FALSE, warning=FALSE}
  tidy.vh.data$Year_Month <- format(ymd(tidy.vh.data$Datum), "%Y-%m")


vh.sum.data <- tidy.vh.data |> 
  group_by(Year_Month) |> 
  summarize(vh_TxpUmsatz = sum(ifelse(is.na(Taxpkt.), 0, Taxpkt.)),
            vh_Auftraege = n_distinct(a_Tagesnummer),
            Anz_Patienten = n_distinct(b_Fallnummer)
  )
vh.sum.data$TxpUmsatz <- vh.sum.data$vh_TxpUmsatz + vh.sum.data$vh_Auftraege * 10
vh.sum.data$vh_TxpUmsatz <- vh.sum.data$vh_TxpUmsatz + vh.sum.data$vh_Auftraege * 10
vh.sum.data <- vh.sum.data |> relocate(TxpUmsatz,  .before = vh_TxpUmsatz)

vh.sum.data |> flextable() |> 
  theme_vanilla() |> 
  bg(bg = "grey", part = "header") |> 
  mk_par(j = 2,
         value = as_paragraph(
           linerange(value = vh_TxpUmsatz, max = max(vh_TxpUmsatz), height = .15)
         ),
         part = "body") |> 
  set_header_labels(
    vh_TxpUmsatz = " ",
    vh_Auftraege = "Auftraege",
    Anz_Patienten = "Patienten (n)"
  ) |> merge_at(j = c(2, 3), part = "header") |> 
  align(align = "center", part = "all")|>
  set_table_properties(width = 0.8, layout = "autofit") |> 
  colformat_date(fmt_date = "%m/%Y") 

```
<br>

<br>

#### Hand-Methoden 2022: Anzahl der einzelnen Analysen pro Quartal

```{r 2022 vh4 analysis, echo=FALSE, message=FALSE, warning=FALSE}
vh.sum.method <- tidy.vh.data |> 
  mutate(Quarter = paste0("Q", quarter(floor_date(Datum, "quarter"))),
         Year = year(Datum)) |> 
  filter(Year == 2022) |> 
  summarise(
    Analysen = n(),
    .by = c(Quarter, Year, Bezeichnung)
  ) |> 
  pivot_wider(
    names_from = c(Quarter, Year), 
    values_from = Analysen, 
    names_sort = TRUE
  )




vh.sum.method |> 
  arrange(desc(Q4_2022)) |>
  flextable() |> 
  theme_vanilla() |> 
  bg(bg = "grey", part = "header") |> 
  add_header_row(
    values = c("Methoden", "n in 2022"),
    colwidths = c(1, 4)) |> 
  theme_box() |>  
  set_header_labels(
    Q1_2022 = "Q1",
    Q2_2022 = "Q2",
    Q3_2022 = "Q3",
    Q4_2022 = "Q4"
  ) |> 
  align(align = "center", part = "all")|>
  set_table_properties(width = 0.8, layout = "autofit")



```


\newpage

### Zusammenfassung spez Chemie

```{r summing_up_specLab, echo=FALSE, message=FALSE, warning=FALSE}
library(dplyr)
library(stringr)

combined.data <- bind_rows(
   ep.sum.data,
  bn.sum.data,
  hplc.sum.data,
  lcms.sum.data,
  vh.sum.data
)
sum.data <- combined.data |> 
  group_by(Year_Month) |> 
  summarize(
    TxpUmsatz_KC = sum(ifelse(is.na(TxpUmsatz), 0, TxpUmsatz)),
    Auftraege_KC = sum(sum(ifelse(is.na(ep_Auftraege), 0, ep_Auftraege)), 
                      sum(ifelse(is.na(bn_Auftraege), 0, bn_Auftraege)),
                      sum(ifelse(is.na(hplc_Auftraege), 0, hplc_Auftraege)),
                      sum(ifelse(is.na(lcms_Auftraege), 0, lcms_Auftraege)),
                      sum(ifelse(is.na(vh_Auftraege), 0, vh_Auftraege))),
    Anz_Patienten_sum = sum(ifelse(is.na(Anz_Patienten), 0, Anz_Patienten
    )))

sum.data$TxpUmsatz <- sum.data$TxpUmsatz_KC
sum.data <- sum.data |> relocate(TxpUmsatz,  .before = TxpUmsatz_KC)
sum.data$Year <- format(ym(sum.data$Year_Month), "%Y")
sum.data <- sum.data |> relocate(Year,  .before = Year_Month) 





sum.data.22 <- sum.data |> filter(Year == "2022")|> subset(select = -c(Year))
sum.data.22 <-  rbind(sum.data.22, c("Total", colSums(sum.data.22[,2:5]))) 
sum.data.22$TxpUmsatz <- as.numeric(sum.data.22$TxpUmsatz)
sum.data.22$TxpUmsatz_KC <- as.numeric(sum.data.22$TxpUmsatz_KC)



sum.data.22 |>  
  flextable() |>  
  theme_vanilla() |> 
  bg(bg = "grey", part = "header") |> 
  mk_par(j = 2,
         value = as_paragraph(
           linerange(value = TxpUmsatz_KC, max = max(TxpUmsatz_KC), height = .15)
         ),
         part = "body") |> 
  set_header_labels(
    TxpUmsatz = "TxpUmsatz -Spez. Chemie-",
    Auftraege_KC = "Auftraege",
    Anz_Patienten_sum = "Patienten (n)"
  ) |> 
  merge_at(j = c(2, 3), part = "header") |> 
  align(align = "center", part = "all")|>
  set_table_properties(width = 0.8, layout = "autofit") |> 
  colformat_date(fmt_date = "%m/%Y") 


```


\newpage

## Zusammenfassung 

```{r summing up, echo=FALSE, message=FALSE, warning=FALSE}
library(dplyr)
library(stringr)

combined.data <- bind_rows(
  AU.sum.data,
  dxi.sum.data,
  ep.sum.data,
  bn.sum.data,
  hplc.sum.data,
  lcms.sum.data,
  vh.sum.data
)
sum.data <- combined.data |> 
  group_by(Year_Month) |> 
  summarize(
    TxpUmsatz_KC = sum(ifelse(is.na(TxpUmsatz), 0, TxpUmsatz)),
    Auftraege_KC = sum(sum(ifelse(is.na(AU_Auftraege), 0, AU_Auftraege)), 
                      sum(ifelse(is.na(DxI_Auftraege), 0, DxI_Auftraege)),
                      sum(ifelse(is.na(ep_Auftraege), 0, ep_Auftraege)), 
                      sum(ifelse(is.na(bn_Auftraege), 0, bn_Auftraege)),
                      sum(ifelse(is.na(hplc_Auftraege), 0, hplc_Auftraege)),
                      sum(ifelse(is.na(lcms_Auftraege), 0, lcms_Auftraege)),
                      sum(ifelse(is.na(vh_Auftraege), 0, vh_Auftraege))),
    Anz_Patienten_sum = sum(ifelse(is.na(Anz_Patienten), 0, Anz_Patienten
    )))

sum.data$TxpUmsatz <- sum.data$TxpUmsatz_KC
sum.data <- sum.data |> relocate(TxpUmsatz,  .before = TxpUmsatz_KC)
sum.data$Year <- format(ym(sum.data$Year_Month), "%Y")
sum.data <- sum.data |> relocate(Year,  .before = Year_Month) 





sum.data.22 <- sum.data |> filter(Year == "2022")|> subset(select = -c(Year))
sum.data.22 <-  rbind(sum.data.22, c("Total", colSums(sum.data.22[,2:5]))) 
sum.data.22$TxpUmsatz <- as.numeric(sum.data.22$TxpUmsatz)
sum.data.22$TxpUmsatz_KC <- as.numeric(sum.data.22$TxpUmsatz_KC)



sum.data.22 |>  
  flextable() |>  
  theme_vanilla() |> 
  bg(bg = "grey", part = "header") |> 
  mk_par(j = 2,
         value = as_paragraph(
           linerange(value = TxpUmsatz_KC, max = max(TxpUmsatz_KC), height = .15)
         ),
         part = "body") |> 
  set_header_labels(
    TxpUmsatz_KC = " ",
    Auftraege_KC = "Auftraege KC",
    Anz_Patienten_sum = "Patienten (n)"
  ) |> 
  merge_at(j = c(2, 3), part = "header") |> 
  align(align = "center", part = "all")|>
  set_table_properties(width = 0.8, layout = "autofit") |> 
  colformat_date(fmt_date = "%m/%Y") 


```



---
  

**Zentrum f체r Labormedizin St. Gallen, `r paste(format(Sys.time(), '%A %d. %B %Y'))`**




---
 
