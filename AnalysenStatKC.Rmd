---
title: "Analysen- & Methoden Statistik Klinische Chemie"
author: "Oliver Speer"
date: "2023-03-20"
output:
  officedown::rdocx_document:
    reference_docx: Formatvorlage_labStatKC.docx
    plots:
      style: Normal
      align: center
      caption:
        style: Image Caption
        pre: 'Figure '
        sep: ':'
---

```{r setup, include=FALSE}
library(knitr)
library(tidyverse)
library(parallel)
library(robslopes)
library(readxl)
library(officedown)
library(officer)
library(flextable)
set_flextable_defaults(font.size = 11, padding = 3)
use_df_printer()
opts_chunk$set(echo = TRUE, ft.align = "center", fig.align = "center")
```


## Entwicklung des Umsatzes einzelner Analysen der Klinischen Chemie  

### Hochdurchsatz  
  
Die Hochdurchsatz-Chemie bestehend aus 2 AU5800 und 2 DxI-800 bildet das R체ckrat des KCHI. Ein regelm채ssiges Monitoring der Umsatzentwicklung in diesem Bereich sollte, neben HRM und QM, ein zentrales Element der F체hrung der Klinischen Chemie sein.   
  
#### AU5800




```{r prepare_data, echo=FALSE, message=FALSE, warning=FALSE}
# import data
library(readxl)
tarif.scales <- read_excel("UmsatzStatistik.xlsx", col_types = c(
  "text",
  "text",
  "text",
  "skip",
  "skip",
  "skip",
  "numeric",
  "skip",
  "numeric",
  "skip"))

head1 <- read_excel("globaldata.xlsx", col_names = TRUE) %>% names()
head2 <- read_excel("globaldata.xlsx", skip = 1, col_names = TRUE) %>% names()
head <- paste0(head2, sep = "_", head1)
global.data <- read_excel("globaldata.xlsx", skip = 2, col_names = head, col_types =
                            c(
                              "text",
                              "skip",
                              "skip",
                              "skip",
                              "date",
                              "text",
                              "text",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric",
                              "numeric"
                            ))

global.data <- global.data |> filter(!grepl("Tagesnummer", global.data$a_Tagesnummer))
global.data <- global.data |> filter(!is.na(a_Tagesnummer))


# change day-number to date and reorder column
global.data$Datum <- ymd(substr(global.data$a_Tagesnummer, 1, 10))
global.data <- cbind(global.data[,1:4], Datum = global.data$Datum, 
                     global.data[,5:ncol(global.data)])

# create new data frame, sort analysis-names in one column (Bezeichnung), 
#code into another (Methode) and results into a third (Werte)
analy.pivot <- global.data |> pivot_longer(
  cols = !(a_Tagesnummer:Datum), 
  names_to = c("Bezeichnung","Methode"),
  names_sep = "_",
  values_to = "Werte",
  values_drop_na = TRUE)

#left join to get tax point information from tariff, remove junk data, save tidy data
anpijona <- left_join(analy.pivot, tarif.scales, by = c("Bezeichnung", "Methode"), keep = FALSE, multiple = "any")

tidy.AU.data <- subset(anpijona, select = -c(Tagesnummer))

write.csv2(tidy.AU.data, "tidyAUdataTxp.csv", col.names = TRUE)

#global.data.sort <- global.data |> group_by(Datum) |>
#  summarise(
#    NaCount = sum(!is.na(Natrium)),
#    CRPCount = sum(!is.na(CRP)),
#    CRPhs = sum(!is.na(`CRP (hoch sensitiv)`))
#  )
```

```{r plotAU, echo=FALSE, message=FALSE, warning=FALSE}
ggplot(data = global.data.sort) + 
  geom_point(mapping =  aes(Datum, CRPCount,)) +
    geom_point(mapping = aes(Datum, NaCount))
```



#### DxI-800
  
  
## Spez. Chemie  
  




---
  

**Zentrum f체r Labormedizin St. Gallen, `r paste(format(Sys.time(), '%A %d. %B %Y'))`**




---
 
